<?php

error_reporting(E_ALL | E_STRICT);

$start = microtime(true);

// CLI options
$opts = getopt('bd::');

// Default driver
if(isset($opts['d'])){
  if(is_string($opts['d']))
    $driver = strtolower(str_replace('=', '', $opts['d']));
  else $driver = 'mysql';
} else $driver = 'mysql';


// Testing interface
include_once dirname(__FILE__) . '/connect.php';

echo "Driver: $driver\n";

foreach(glob(dirname(__FILE__).'/*.phpt') as $test){

  ob_start();
  include_once $test;
  $file = basename($test);

  if(!preg_match("~^--TEST--\r?\n(.*)\n--FILE--\r?\n(.*)--EXPECTF?--\r?\n(.*)~s", ob_get_clean(), $matches))
    fwrite(STDERR, "Error: invalid test file $file\n");

  elseif($matches[2] !== $matches[3]){
    fwrite(STDERR, "Error: Test $file failed - $matches[1]\n");
    
    // Debug mode (-b option)
    if(isset($opts['b']))
      echo "EXPECT:\n$matches[3]\n-\nRESULT:\n$matches[2]\n-\n\n";
  }
}

printf("\n%.3F sec, %d KB\n", microtime(true) - $start, memory_get_peak_usage() / 1024);
