<?php
$start = microtime(true);

$opts = getopt('d');

if(isset($opts['d']))
  define('DEBUG', true);
else define('DEBUG', false);

include_once dirname(__FILE__) . '/connect.php';

$tests = glob(dirname(__FILE__).'/*.phpt');

echo "\n";

foreach($tests as $test){

  ob_start();
  include $test;
  $file = basename($test);

  $result = ob_get_clean();
  if(!preg_match("~^--TEST\n(.*)\n--CODE\n(.*)--RESULT\n(.*)~s", $result, $matches))
    echo "Invalid $file\n";

  elseif($matches[2] !== $matches[3])
    echo "$file failed - $matches[1]\n";

  if(DEBUG)
    echo $matches[2], "\n------\n", $matches[3];
}

echo "\n";
printf("%.3F sec, %d KB\n", microtime(true) - $start, memory_get_peak_usage() / 1024);

?>